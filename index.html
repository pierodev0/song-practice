<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SongPractice Studio | Pro Library</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --primary: #f59e0b;
            --bg: #0f172a;
            --panel-bg: #1e293b;
            --text: #f1f5f9;
            --accent: #38bdf8;
            --success: #10b981;
            --font-mono: 'Courier New', Courier, monospace;
            --sidebar-width: 340px;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 140px;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #111827;
            border-right: 1px solid #334155;
            position: fixed; top: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 2000; display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        
        .playlists-section {
            background: #0f172a; padding: 15px; border-bottom: 2px solid #334155; flex-shrink: 0; 
        }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .playlist-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: thin; }
        .playlist-chip {
            background: #334155; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; border: 1px solid transparent; flex-shrink: 0; color: #cbd5e1; transition: all 0.2s;
        }
        .playlist-chip.active { background: var(--primary); color: #0f172a; font-weight: bold; border-color: var(--primary); box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        
        .songs-section { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
        .sidebar-title { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: bold; padding-left: 5px; border-left: 3px solid var(--accent); }

        .song-item {
            background: #1f2937; padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; user-select: none;
        }
        .song-item:hover { background: #374151; }
        .song-item.active { border-color: var(--primary); background: rgba(245, 158, 11, 0.15); } 
        .sortable-ghost { opacity: 0.4; background: #475569; border: 1px dashed var(--primary); }
        .drag-handle { cursor: grab; color: #64748b; margin-right: 10px; font-size: 1.2rem; }
        
        .song-type { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; text-transform: uppercase; font-weight: bold; }
        .type-yt { background: #dc2626; color: white; }
        .type-mp3 { background: #ea580c; color: white; }

        /* --- LAYOUT --- */
        .main-content { padding: 20px; margin: 0 auto; max-width: 950px; }
        header { border-bottom: 1px solid #334155; margin-bottom: 20px; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.6rem; color: white; }
        h1 span { color: var(--primary); }

        .config-panel {
            background: var(--panel-bg); padding: 25px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #334155;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); transition: all 0.3s; overflow: hidden; max-height: 1200px; opacity: 1;
        }
        .config-panel.collapsed { max-height: 0; opacity: 0; margin: 0; padding: 0; border: none; }

        .source-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #94a3b8; padding: 8px 16px; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .source-content { display: none; }
        .source-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        input, textarea, select { width: 100%; background: #020617; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 200px; font-family: var(--font-mono); }

        .file-upload { position: relative; display: inline-block; width: 100%; }
        .file-upload input[type="file"] { display: none; }
        .file-upload-label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; background: #0f172a; border: 1px dashed #475569; border-radius: 8px; cursor: pointer; color: #94a3b8; transition: 0.2s; box-sizing: border-box; }
        .file-upload-label.loaded { border-color: var(--primary); color: var(--primary); background: rgba(16, 185, 129, 0.1); }

        button { background: #334155; color: white; border: 1px solid #475569; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        button:hover { background: #475569; }
        button.primary { background: var(--primary); border-color: var(--primary); color: #0f172a; }
        button.btn-new { background: var(--success); border-color: var(--success); color: #0f172a; }
        button.btn-new:hover { background: #059669; }
        button.save-btn { background: #059669; border-color: #059669; width: 100%; justify-content: center; margin-top: 15px; color: white; }
        .icon-btn { padding: 6px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; cursor: pointer; font-size: 0.9rem; margin-left: 5px; }
        .icon-btn:hover { background: #334155; color: white; }
        .icon-btn.danger:hover { background: #7f1d1d; border-color: #ef4444; color: white; }

        #songContainer { background: white; color: #1e293b; padding: 60px; border-radius: 8px; min-height: 800px; font-family: var(--font-mono); white-space: pre; line-height: 1.6; font-size: 17px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        #songContainer strong { color: var(--primary); font-weight: 900; }

        #mediaContainer { position: fixed; bottom: 110px; right: 20px; width: 320px; height: 180px; z-index: 999; display: none; background: black; border-radius: 12px; overflow: hidden; border: 2px solid #334155; box-shadow: 0 20px 25px rgba(0,0,0,0.6); }
        #audioVisualizer { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(to bottom, #1e1b4b, #000); color: white; }
        .drag-handle-window { position: absolute; top: 0; left: 0; right: 0; height: 30px; background: rgba(255,255,255,0.1); cursor: move; z-index: 1000; }

        .player-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); border-top: 1px solid #334155; padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; height: 80px; }
        .controls-center { display: flex; align-items: center; gap: 20px; position: absolute; left: 50%; transform: translateX(-50%); }
        .play-btn { width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: #0f172a; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .skip-btn { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
        .badge { background: #334155; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; color: #cbd5e1; }
        .badge.active { background: #10b981; color: white; }
        .db-status { position: fixed; bottom: 90px; left: 20px; font-size: 0.7rem; color: #64748b; z-index: 900; }

        /* MODAL B√öSQUEDA */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-bg); padding: 25px; border-radius: 12px; width: 400px; max-width: 90%; border: 1px solid #334155; box-shadow: 0 20px 25px rgba(0,0,0,0.5); }
        .modal-list { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #334155; border-radius: 8px; }
        .modal-item { padding: 10px; border-bottom: 1px solid #334155; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; }
        .modal-item:hover { background: #334155; }
        .modal-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="playlists-section">
        <div class="playlist-header">
            <h4 style="margin:0; color:white;">MIS PLAYLISTS</h4>
            <button class="icon-btn" onclick="createNewPlaylist()" title="Nueva Playlist">‚ûï</button>
        </div>
        <div class="playlist-list" id="playlistsContainer"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding-top:10px; border-top:1px solid #1e293b;">
            <span id="currentPlaylistNameDisplay" style="font-weight:bold; color:#cbd5e1; font-size:0.9rem;">...</span>
            <div>
                <button class="icon-btn" onclick="renameCurrentPlaylist()" title="Renombrar">‚úèÔ∏è</button>
                <button class="icon-btn danger" onclick="deleteCurrentPlaylist()" title="Borrar Playlist">üóëÔ∏è</button>
            </div>
        </div>
    </div>
    <div class="songs-section">
        <div class="sidebar-title">Canciones en Lista</div>
        <div id="songsListContainer"></div>
    </div>
    <div style="padding:15px; border-top:1px solid #334155;">
        <button onclick="toggleSidebar()" style="width:100%; justify-content:center;">Cerrar Men√∫</button>
    </div>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="toggleSidebar()" style="background:transparent; border:1px solid #475569;">‚ò∞ <span id="headerPlaylistName">Lista</span></button>
            <h1>SongPractice <span>Pro</span></h1>
        </div>
        
        <div style="display:flex; gap: 10px;">
            <button onclick="openLibraryModal()" style="background: #334155; border: 1px solid #64748b;">üîç Agregar Existente</button>
            <button onclick="startNewSong()" class="btn-new">‚ûï Nueva</button>
            <button onclick="toggleEditMode()" id="modeBtn">‚öôÔ∏è Configurar</button>
        </div>
    </header>

    <div class="config-panel collapsed" id="configPanel">
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>T√≠tulo Canci√≥n</label>
                <input type="text" id="songTitle" placeholder="Nombre...">
            </div>
        </div>
        <div class="source-tabs">
            <button class="tab-btn active" onclick="switchTab('youtube')" id="tabYoutube">YouTube</button>
            <button class="tab-btn" onclick="switchTab('mp3')" id="tabMp3">Archivo MP3</button>
        </div>
        <div id="sourceYoutube" class="source-content active">
            <label>Link de YouTube</label>
            <input type="text" id="ytUrl" placeholder="https://www.youtube.com/..." onchange="loadSourceMedia()">
        </div>
        <div id="sourceMp3" class="source-content">
            <label>Subir MP3 (Persistente)</label>
            <div class="file-upload">
                <label for="mp3Input" class="file-upload-label" id="mp3Label">üìÇ Seleccionar archivo</label>
                <input type="file" id="mp3Input" accept="audio/*" onchange="handleFileSelect(this)">
            </div>
        </div>
        <div class="form-grid" style="margin-top:15px;">
            <div>
                <label>Duraci√≥n</label>
                <input type="text" id="songDuration" placeholder="00:00" readonly>
            </div>
            <div style="align-self:end; color:#64748b; font-size:0.8rem; padding-bottom:10px;" id="durationStatus">...</div>
        </div>
        <label>Letra y Acordes</label>
        <textarea id="inputArea" spellcheck="false" placeholder="Pega la letra..."></textarea>
        <button class="save-btn" onclick="saveToLibraryAndPlaylist()">üíæ Guardar Cambios</button>
        <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="transpose(-1)">‚ûñ Tono</button>
            <span id="keyDisplay" style="background:#0f172a; padding:0 20px; border-radius:8px; display:flex; align-items:center; font-weight:bold; border:1px solid #334155;">Original</span>
            <button onclick="transpose(1)">‚ûï Tono</button>
            <div style="flex-grow:1;"></div>
            <button class="primary" onclick="closeEditor()">‚ùå Cancelar</button>
        </div>
    </div>

    <div id="songContainer">
        <div style="text-align:center; padding-top:100px; color:#64748b;">
            <h2>Selecciona una canci√≥n</h2>
            <p>O usa "Nueva" para crear.</p>
        </div>
    </div>
</div>

<div id="mediaContainer">
    <div class="drag-handle-window"></div>
    <div id="youtube-player" style="display:none; height:100%;"></div>
    <div id="audioVisualizer" style="display:none;">
        <div style="font-size:3rem;">üíæ</div>
        <div style="margin-top:10px; font-weight:bold; color:#a5b4fc;">Audio Local</div>
        <audio id="html5Player" style="width:100%; margin-top:15px;" controls></audio>
    </div>
</div>

<div class="player-bar">
    <div style="width:180px;">
        <div id="statusText" style="font-weight:bold;">Listo</div>
        <div id="timeDisplay" style="font-size:0.8rem; color:#94a3b8; font-family:var(--font-mono);">00:00</div>
    </div>
    <div class="controls-center">
        <button class="skip-btn" onclick="playPrev()">‚èÆ</button>
        <button class="play-btn" id="masterPlayBtn" onclick="toggleGlobalPlay()">‚ñ∂</button>
        <button class="skip-btn" onclick="playNext()">‚è≠</button>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
        <span class="badge" id="speedBadge">Manual</span>
        <input type="range" id="scrollSpeed" min="0" max="100" value="0" step="0.5" style="width:120px;">
    </div>
</div>

<div class="modal-overlay" id="libraryModal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:white;">üìö Biblioteca Global</h3>
        <input type="text" id="searchLibrary" placeholder="Filtrar..." onkeyup="renderLibraryList()" style="margin-bottom:10px;">
        <div class="modal-list" id="libraryList"></div>
        <button onclick="closeLibraryModal()" style="width:100%; margin-top:15px;">Cerrar</button>
    </div>
</div>

<div class="db-status" id="dbStatus">DB: Init...</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ==========================================
    // 1. DATABASE (Audio Files)
    // ==========================================
    const DB_NAME = 'SongPracticeDB'; const STORE_NAME = 'audioFiles'; let db;
    function initDB() {
        const r = indexedDB.open(DB_NAME, 1);
        r.onupgradeneeded = (e) => { db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME); };
        r.onsuccess = (e) => { db = e.target.result; document.getElementById('dbStatus').innerText = "DB: OK"; initAppData(); };
        r.onerror = () => document.getElementById('dbStatus').innerText = "DB Error";
    }
    function storeAudioFile(id, file, cb) { const tx = db.transaction([STORE_NAME], 'readwrite'); tx.objectStore(STORE_NAME).put(file, id).onsuccess = () => cb(true); tx.onerror = () => cb(false); }
    function getAudioFile(id, cb) { const tx = db.transaction([STORE_NAME], 'readonly'); tx.objectStore(STORE_NAME).get(id).onsuccess = (e) => cb(e.target.result); tx.onerror = () => cb(null); }
    function deleteAudioFile(id) { db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(id); }

    // ==========================================
    // 2. DATA STRUCTURE (RELATIONAL)
    // ==========================================
    // Estructura: 
    // library: { "id1": {title, content, type, url, ...}, "id2": {...} }
    // playlists: [ {id, name, songIds: ["id1", "id2"]} ]
    
    let appData = { library: {}, playlists: [], activePlaylistId: null };

    function initAppData() {
        // CAMBIO DE VERSI√ìN PARA ROMPER RETROCOMPATIBILIDAD
        const data = localStorage.getItem('songPracticeData_v2_relational');
        if (data) {
            appData = JSON.parse(data);
            if(!appData.playlists.find(p => p.id === appData.activePlaylistId)) {
                appData.activePlaylistId = appData.playlists[0]?.id || createDefaultPlaylist();
            }
        } else {
            createDefaultPlaylist();
        }
        renderSidebarPlaylists();
        loadCurrentPlaylistSongs();
        initSortable();
    }

    function createDefaultPlaylist() {
        const pid = Date.now().toString();
        appData.library = {};
        appData.playlists = [{ id: pid, name: "General", songIds: [] }];
        appData.activePlaylistId = pid;
        saveAppData();
        return pid;
    }

    function saveAppData() {
        localStorage.setItem('songPracticeData_v2_relational', JSON.stringify(appData));
    }

    function getActivePlaylist() {
        return appData.playlists.find(p => p.id === appData.activePlaylistId);
    }
    
    // Obtener objeto canci√≥n completo a partir de su ID
    function getSongById(id) {
        return appData.library[id];
    }

    // ==========================================
    // 3. SORTABLE
    // ==========================================
    function initSortable() {
        Sortable.create(document.getElementById('songsListContainer'), {
            animation: 150, ghostClass: 'sortable-ghost', handle: '.song-item',
            onEnd: function (evt) {
                const active = getActivePlaylist();
                const movedId = active.songIds.splice(evt.oldIndex, 1)[0];
                active.songIds.splice(evt.newIndex, 0, movedId);
                
                // Ajustar currentIndex
                if (currentIndex === evt.oldIndex) currentIndex = evt.newIndex;
                else if (currentIndex > evt.oldIndex && currentIndex <= evt.newIndex) currentIndex--;
                else if (currentIndex < evt.oldIndex && currentIndex >= evt.newIndex) currentIndex++;
                
                saveAppData();
            }
        });
    }

    // ==========================================
    // 4. PLAYLIST & LIBRARY LOGIC
    // ==========================================
    function createNewPlaylist() {
        const name = prompt("Nombre:", "Nueva Lista");
        if(name) {
            const newId = "pl_" + Date.now();
            appData.playlists.push({ id: newId, name: name, songIds: [] });
            switchPlaylist(newId);
        }
    }

    function switchPlaylist(id) {
        appData.activePlaylistId = id;
        saveAppData();
        currentIndex = -1; 
        renderSidebarPlaylists();
        loadCurrentPlaylistSongs();
        stopGlobal();
    }
    
    function deleteCurrentPlaylist() {
        if(appData.playlists.length <= 1) return alert("No puedes borrar la √∫ltima playlist.");
        if(confirm("¬øBorrar playlist? Las canciones seguir√°n en la Biblioteca.")) {
            appData.playlists = appData.playlists.filter(p => p.id !== appData.activePlaylistId);
            switchPlaylist(appData.playlists[0].id);
        }
    }
    
    function renameCurrentPlaylist() {
        const active = getActivePlaylist();
        const n = prompt("Nombre:", active.name);
        if(n) { active.name = n; saveAppData(); renderSidebarPlaylists(); }
    }

    function renderSidebarPlaylists() {
        const container = document.getElementById('playlistsContainer');
        const active = getActivePlaylist();
        container.innerHTML = appData.playlists.map(p => `
            <div class="playlist-chip ${p.id === appData.activePlaylistId ? 'active' : ''}" onclick="switchPlaylist('${p.id}')">
                ${p.name} <span style="opacity:0.6; font-size:0.7em;">(${p.songIds.length})</span>
            </div>
        `).join('');
        document.getElementById('currentPlaylistNameDisplay').innerText = active ? active.name : "";
        document.getElementById('headerPlaylistName').innerText = active ? active.name : "";
    }

    // ==========================================
    // 5. SONG MANAGEMENT (RELATIONAL)
    // ==========================================
    let currentMode = 'youtube'; let currentIndex = -1; let currentSongId = null;
    let ytPlayer; let audioPlayer = document.getElementById('html5Player'); let tempMp3File = null;

    function loadCurrentPlaylistSongs() {
        const active = getActivePlaylist();
        const container = document.getElementById('songsListContainer');
        container.innerHTML = "";
        
        if(!active || active.songIds.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Lista vac√≠a<br><small>Arrastra para ordenar</small></div>';
            return;
        }

        container.innerHTML = active.songIds.map((sid, i) => {
            const s = getSongById(sid);
            if(!s) return ''; // Error data integrity
            return `
            <div class="song-item ${i === currentIndex ? 'active' : ''}" onclick="loadSongByIndex(${i})">
                <div style="display:flex; align-items:center; overflow:hidden;">
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <div style="overflow:hidden;">
                        <div style="font-weight:bold; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.title}</div>
                        <div style="font-size:0.7rem; color:#94a3b8; display:flex; align-items:center; margin-top:4px;">
                            <span class="song-type ${s.type==='youtube'?'type-yt':'type-mp3'}">${s.type==='youtube'?'YT':'MP3'}</span>
                            ${s.duration || '--:--'}
                        </div>
                    </div>
                </div>
                <button onclick="deleteSongAction(event, ${i})" style="background:none; border:none; color:#ef4444; padding:0; font-size:1.2rem;" title="Quitar">√ó</button>
            </div>`;
        }).join('');
    }

    function loadSongByIndex(index) {
        const active = getActivePlaylist();
        if(!active || !active.songIds[index]) return;

        currentIndex = index;
        currentSongId = active.songIds[index];
        const s = getSongById(currentSongId);

        // Cargar datos en formulario (para edici√≥n)
        document.getElementById('songTitle').value = s.title;
        document.getElementById('inputArea').value = s.content;
        document.getElementById('songDuration').value = s.duration;
        currentStep = s.transpose || 0;
        document.getElementById('keyDisplay').innerText = currentStep === 0 ? "Original" : (currentStep > 0 ? "+" : "") + currentStep;

        updateSongView();
        switchTab(s.type);
        loadCurrentPlaylistSongs(); 

        if (s.type === 'youtube') {
            document.getElementById('ytUrl').value = s.url;
            cueVideoById();
        } else {
            document.getElementById('durationStatus').innerText = "Cargando audio...";
            getAudioFile(s.url, (blob) => {
                if(blob) {
                    audioPlayer.src = URL.createObjectURL(blob);
                    document.getElementById('mp3Label').innerText = "üìÇ Audio Cargado";
                    document.getElementById('mp3Label').classList.add('loaded');
                    document.getElementById('durationStatus').innerHTML = "<span style='color:#10b981'>‚úÖ Audio Listo</span>";
                    calculateSpeedFromDuration();
                }
            });
        }
        restartPractice();
    }

    // --- NUEVO SISTEMA DE GUARDADO ---
    function startNewSong() {
        currentIndex = -1;
        currentSongId = null; // Nueva ID se generar√° al guardar
        clearForm();
        document.getElementById('configPanel').classList.remove('collapsed');
        document.getElementById('modeBtn').innerText = "Ocultar Editor";
        stopGlobal();
        document.getElementById('songContainer').innerHTML = `<div style="text-align:center; padding-top:50px; color:#cbd5e1;"><h2>Nueva Canci√≥n</h2><p>Rellena datos y guarda.</p></div>`;
    }

    async function saveToLibraryAndPlaylist() {
        const active = getActivePlaylist();
        const title = document.getElementById('songTitle').value || "Sin T√≠tulo";
        const content = document.getElementById('inputArea').value;
        const duration = document.getElementById('songDuration').value;
        const type = currentMode;
        
        // Determinar ID: si editamos usamos la actual, si es nueva generamos una
        const idToSave = currentSongId || "song_" + Date.now();
        let urlData = (type === 'youtube') ? document.getElementById('ytUrl').value : idToSave; // Para MP3 usamos el ID como key

        // Funci√≥n interna para finalizar guardado
        const finalize = () => {
            // 1. Guardar/Actualizar en LIBRER√çA
            appData.library[idToSave] = {
                id: idToSave, title, content, duration, type, url: urlData, transpose: currentStep
            };

            // 2. Si es NUEVA en esta playlist, agregar ID
            if (currentIndex === -1) {
                // Verificar si ya existe en esta playlist para no duplicar ID
                if(!active.songIds.includes(idToSave)) {
                    active.songIds.push(idToSave);
                    currentIndex = active.songIds.length - 1;
                }
            }
            // Si es EDICI√ìN, no hacemos nada con la playlist, porque solo referencia al ID

            currentSongId = idToSave;
            saveAppData();
            renderSidebarPlaylists();
            loadCurrentPlaylistSongs();
            closeEditor();
            loadSongByIndex(currentIndex); // Recargar para ver cambios
            tempMp3File = null;
        };

        if (type === 'mp3' && tempMp3File) {
            storeAudioFile(idToSave, tempMp3File, (success) => {
                if(success) finalize();
                else alert("Error guardando audio");
            });
        } else {
            finalize();
        }
    }

    // --- ELIMINAR O QUITAR ---
    function deleteSongAction(e, i) {
        e.stopPropagation();
        const active = getActivePlaylist();
        const sid = active.songIds[i];
        
        // UX Profesional: Preguntar intenci√≥n
        if(confirm(`¬øQuitar "${appData.library[sid].title}" de ESTA lista?\n(Seguir√° existiendo en la biblioteca)`)) {
             active.songIds.splice(i, 1);
             if(i === currentIndex) currentIndex = -1;
             saveAppData();
             loadCurrentPlaylistSongs();
        }
        // Nota: Para "Borrar Permanentemente" se har√≠a desde el Modal de Biblioteca
    }

    // --- MODAL DE BIBLIOTECA (Agregar existente) ---
    function openLibraryModal() {
        document.getElementById('libraryModal').style.display = 'flex';
        renderLibraryList();
    }
    function closeLibraryModal() {
        document.getElementById('libraryModal').style.display = 'none';
    }
    function renderLibraryList() {
        const filter = document.getElementById('searchLibrary').value.toLowerCase();
        const listDiv = document.getElementById('libraryList');
        const active = getActivePlaylist();
        
        // Obtener todas las canciones de la librer√≠a
        const allSongs = Object.values(appData.library);
        
        // Filtrar por texto y excluir las que YA est√°n en la playlist actual
        const filtered = allSongs.filter(s => {
            const matchText = s.title.toLowerCase().includes(filter);
            const alreadyInList = active.songIds.includes(s.id);
            return matchText && !alreadyInList;
        });

        if(filtered.length === 0) {
            listDiv.innerHTML = '<div style="padding:10px; color:#94a3b8;">No hay canciones coincidentes o disponibles.</div>';
            return;
        }

        listDiv.innerHTML = filtered.map(s => `
            <div class="modal-item" onclick="addExistingToPlaylist('${s.id}')">
                <span>${s.title}</span>
                <span class="song-type ${s.type==='youtube'?'type-yt':'type-mp3'}" style="margin-left:auto;">${s.type==='youtube'?'YT':'MP3'}</span>
            </div>
        `).join('');
    }

    function addExistingToPlaylist(sid) {
        const active = getActivePlaylist();
        active.songIds.push(sid);
        saveAppData();
        loadCurrentPlaylistSongs();
        closeLibraryModal();
        
        // Feedback visual r√°pido
        const btn = document.querySelector('button[onclick="openLibraryModal()"]');
        const origText = btn.innerText;
        btn.innerText = "‚úÖ Agregado";
        setTimeout(() => btn.innerText = origText, 1000);
    }

    // ==========================================
    // UTILS & UI (Sin cambios mayores)
    // ==========================================
    function clearForm() {
        document.getElementById('songTitle').value = "";
        document.getElementById('ytUrl').value = "";
        document.getElementById('inputArea').value = "";
        document.getElementById('songDuration').value = "";
        document.getElementById('mp3Input').value = ""; 
        document.getElementById('mp3Label').innerText = "üìÇ Seleccionar archivo";
        document.getElementById('mp3Label').classList.remove('loaded');
        currentStep = 0;
        document.getElementById('keyDisplay').innerText = "Original";
        tempMp3File = null;
    }
    function closeEditor() {
        document.getElementById('configPanel').classList.add('collapsed');
        document.getElementById('modeBtn').innerText = "‚öôÔ∏è Configurar";
        if(currentIndex === -1 && !currentSongId) clearForm();
    }
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            tempMp3File = input.files[0];
            document.getElementById('mp3Label').innerText = "üìÇ " + tempMp3File.name;
            audioPlayer.src = URL.createObjectURL(tempMp3File);
        }
    }
    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.source-content').forEach(c => c.classList.remove('active'));
        if (mode === 'youtube') {
            document.getElementById('tabYoutube').classList.add('active');
            document.getElementById('sourceYoutube').classList.add('active');
        } else {
            document.getElementById('tabMp3').classList.add('active');
            document.getElementById('sourceMp3').classList.add('active');
        }
        stopGlobal();
    }
    function toggleEditMode() {
        const p = document.getElementById('configPanel');
        if(p.classList.contains('collapsed')) {
            p.classList.remove('collapsed'); document.getElementById('modeBtn').innerText="Ocultar Editor"; stopGlobal();
        } else { closeEditor(); }
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    
    // PLAYER ENGINE
    function toggleGlobalPlay() {
        if(currentMode === 'youtube') {
            if(!ytPlayer || !ytPlayer.getPlayerState) return;
            const s = ytPlayer.getPlayerState();
            s === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
        } else { audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause(); }
    }
    function stopGlobal() { if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo(); audioPlayer.pause(); stopScrollEngine(); }
    function updatePlayerState(s) {
        const btn = document.getElementById('masterPlayBtn');
        const media = document.getElementById('mediaContainer');
        if(s === 'playing') {
            btn.innerText = "‚ùö‚ùö"; startScrollEngine(); media.style.display = 'block';
            document.getElementById('youtube-player').style.display = currentMode==='youtube'?'block':'none';
            document.getElementById('audioVisualizer').style.display = currentMode==='mp3'?'flex':'none';
        } else { btn.innerText = "‚ñ∂"; stopScrollEngine(); }
    }
    function restartPractice() {
        window.scrollTo(0,0);
        if(currentMode==='youtube' && ytPlayer.seekTo) { ytPlayer.seekTo(0); ytPlayer.pauseVideo(); }
        if(currentMode==='mp3') { audioPlayer.currentTime=0; audioPlayer.pause(); }
        stopScrollEngine(); scrollAccumulator=0; document.getElementById('masterPlayBtn').innerText="‚ñ∂";
    }
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('youtube-player', {
            height: '100%', width: '100%', playerVars: { 'playsinline': 1 },
            events: {
                'onStateChange': (e) => {
                    if(currentMode !== 'youtube') return;
                    if(e.data===YT.PlayerState.PLAYING) updatePlayerState('playing');
                    else if(e.data===YT.PlayerState.PAUSED) updatePlayerState('paused');
                    else if(e.data===YT.PlayerState.ENDED) { updatePlayerState('ended'); setTimeout(playNext, 2000); }
                    if(e.data===YT.PlayerState.CUED||e.data===YT.PlayerState.PLAYING){ const d=ytPlayer.getDuration(); if(d>0) { document.getElementById('songDuration').value=formatTime(d); calculateSpeedFromDuration(); }}
                }
            }
        });
    }
    function cueVideoById() {
        const url=document.getElementById('ytUrl').value;
        const m=url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        if(m && m[2].length==11) { document.getElementById('mediaContainer').style.display='block'; ytPlayer.cueVideoById(m[2]); }
    }
    function loadSourceMedia() { if(currentMode==='youtube') cueVideoById(); }
    
    // TRANSPOSE & SCROLL (Igual que antes)
    const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const flats=['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    let currentStep=0;
    const chordRegex=/\b([A-G][b#]?(?:maj|min|m|M|aug|dim|sus|add|alt|b5|#5|[0-9]|\+|\-|\(|\))*)(?:\/([A-G][b#]?))?\b/g;
    document.getElementById('inputArea').addEventListener('input', updateSongView);
    function transpose(d){currentStep+=d; document.getElementById('keyDisplay').innerText=currentStep===0?"Original":(currentStep>0?"+":"")+currentStep; updateSongView();}
    function updateSongView(){
        const txt=document.getElementById('inputArea').value; const lines=txt.split('\n'); let used=[];
        const p=lines.map(l=>{ if(isChordLine(l)){ return l.replace(chordRegex,(m,r,b)=>{const tr=tn(r,currentStep); const tb=b?"/"+tn(b,currentStep):""; const f=tr+tb; if(!used.includes(f))used.push(f); return `<strong>${f}</strong>`;}); } return l.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); });
        let leg=used.length?`<div style="margin-bottom:30px; padding:20px; background:#f8fafc; border-left:5px solid var(--primary); color:#334155; border-radius:4px;">üé∏ <b>ACORDES:</b> ${used.join(' ')}</div>`:"";
        document.getElementById('songContainer').innerHTML=leg+p.join('\n')+"<br><br><br><br>";
    }
    function isChordLine(l){if(!l.trim())return false; const w=l.trim().split(/\s+/); let c=0; w.forEach(x=>{if(x.replace(/[()]/g,'').match(/^[A-G][b#]?(maj|min|m|M|aug|dim|sus|add|alt|b5|#5|[0-9]|\+|\-|\(|\/)*$/))c++;}); return (c/w.length>0.4)&&!w.some(k=>k.length>8);}
    function tn(p,s){return p.replace(/[A-G][b#]?/,(n)=>{let i=notes.indexOf(n); let uf=(i===-1&&flats.indexOf(n)!==-1); if(i===-1)i=flats.indexOf(n); if(i===-1)return n; let ni=(i+s)%12; while(ni<0)ni+=12; return uf?flats[ni]:notes[ni];});}
    function playNext() { const active=getActivePlaylist(); if(!active||!active.songIds.length)return; let n=currentIndex+1; if(n>=active.songIds.length)n=0; loadSongByIndex(n); }
    function playPrev() { const active=getActivePlaylist(); if(!active||!active.songIds.length)return; let n=currentIndex-1; if(n<0)n=active.songIds.length-1; loadSongByIndex(n); }
    function formatTime(s){const m=Math.floor(s/60); const sc=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;}
    let useCalculatedSpeed=false, calculatedPixelsPerFrame=0, isScrolling=false, scrollAccumulator=0, scrollRequest;
    function calculateSpeedFromDuration(){
        const v=document.getElementById('songDuration').value; if(!v.includes(':'))return; const p=v.split(':'); const sec=(parseInt(p[0])*60)+parseInt(p[1]); if(sec<=0)return;
        const dist=document.body.scrollHeight-window.innerHeight; if(dist<=0)return;
        calculatedPixelsPerFrame=(dist/sec)/60; useCalculatedSpeed=true; document.getElementById('speedBadge').innerText="AUTO"; document.getElementById('speedBadge').classList.add('active'); document.getElementById('scrollSpeed').value=calculatedPixelsPerFrame*20;
    }
    function startScrollEngine(){ isScrolling=true; function loop(){ if(!isScrolling)return; const atBottom=(window.innerHeight+window.scrollY)>=document.body.offsetHeight-2; if(!atBottom){ let ppf=useCalculatedSpeed?calculatedPixelsPerFrame:(parseFloat(document.getElementById('scrollSpeed').value)/20); if(ppf>0){ scrollAccumulator+=ppf; if(scrollAccumulator>=1){const m=Math.floor(scrollAccumulator); window.scrollBy(0,m); scrollAccumulator-=m;}} } scrollRequest=requestAnimationFrame(loop); } scrollRequest=requestAnimationFrame(loop); }
    function stopScrollEngine(){isScrolling=false; cancelAnimationFrame(scrollRequest);}
    document.getElementById('scrollSpeed').addEventListener('input',()=>{useCalculatedSpeed=false; document.getElementById('speedBadge').innerText="MANUAL"; document.getElementById('speedBadge').classList.remove('active');});
    setInterval(()=>{
        let c=0; let t=document.getElementById('songDuration').value||"00:00";
        if(currentMode==='youtube'&&ytPlayer&&ytPlayer.getCurrentTime) c=ytPlayer.getCurrentTime(); else if(currentMode==='mp3') c=audioPlayer.currentTime;
        document.getElementById('timeDisplay').innerText=`${formatTime(c)} / ${t}`;
    },1000);
    
    document.addEventListener('DOMContentLoaded', initDB);
</script>
</body>
</html>