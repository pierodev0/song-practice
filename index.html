<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SongPractice Studio | UX Mejorado</title>
    <style>
        :root {
            --primary: #f59e0b; /* Amber/Dorado para resaltar */
            --bg: #0f172a;
            --panel-bg: #1e293b;
            --text: #f1f5f9;
            --accent: #38bdf8;
            --success: #10b981;
            --font-mono: 'Courier New', Courier, monospace;
            --sidebar-width: 340px;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 140px;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #111827;
            border-right: 1px solid #334155;
            position: fixed; top: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 2000; display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }
        
        .playlists-section {
            background: #0f172a;
            padding: 15px;
            border-bottom: 2px solid #334155;
            flex-shrink: 0; 
        }
        .playlist-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .playlist-list {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px;
            scrollbar-width: thin;
        }
        .playlist-chip {
            background: #334155; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; white-space: nowrap; cursor: pointer; border: 1px solid transparent; flex-shrink: 0; color: #cbd5e1; transition: all 0.2s;
        }
        .playlist-chip.active { background: var(--primary); color: #0f172a; font-weight: bold; border-color: var(--primary); box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .playlist-chip:hover:not(.active) { background: #475569; }

        .songs-section { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
        .sidebar-title { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: bold; padding-left: 5px; border-left: 3px solid var(--accent); }

        .song-item {
            background: #1f2937; padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
        }
        .song-item:hover { background: #374151; }
        .song-item.active { border-color: var(--primary); background: rgba(245, 158, 11, 0.15); } 
        
        .song-type { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; text-transform: uppercase; font-weight: bold; }
        .type-yt { background: #dc2626; color: white; }
        .type-mp3 { background: #ea580c; color: white; }

        /* --- LAYOUT --- */
        .main-content { padding: 20px; margin: 0 auto; max-width: 950px; }
        header { border-bottom: 1px solid #334155; margin-bottom: 20px; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.6rem; color: white; }
        h1 span { color: var(--primary); }

        .config-panel {
            background: var(--panel-bg); padding: 25px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #334155;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); transition: all 0.3s; overflow: hidden; max-height: 1200px; opacity: 1;
        }
        .config-panel.collapsed { max-height: 0; opacity: 0; margin: 0; padding: 0; border: none; }

        .source-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #94a3b8; padding: 8px 16px; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .source-content { display: none; }
        .source-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        input, textarea { width: 100%; background: #020617; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        textarea { height: 200px; font-family: var(--font-mono); }

        .file-upload { position: relative; display: inline-block; width: 100%; }
        .file-upload input[type="file"] { display: none; }
        .file-upload-label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; background: #0f172a; border: 1px dashed #475569; border-radius: 8px; cursor: pointer; color: #94a3b8; transition: 0.2s; box-sizing: border-box; }
        .file-upload-label.loaded { border-color: var(--primary); color: var(--primary); background: rgba(16, 185, 129, 0.1); }

        button { background: #334155; color: white; border: 1px solid #475569; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        button:hover { background: #475569; }
        button.primary { background: var(--primary); border-color: var(--primary); color: #0f172a; }
        /* Nuevo bot√≥n verde para agregar */
        button.btn-new { background: var(--success); border-color: var(--success); color: #0f172a; }
        button.btn-new:hover { background: #059669; }

        button.save-btn { background: #059669; border-color: #059669; width: 100%; justify-content: center; margin-top: 15px; color: white; }
        
        /* BOTONES DE ICONO (L√°piz y Tacho) */
        .icon-btn { padding: 6px; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #94a3b8; cursor: pointer; font-size: 0.9rem; margin-left: 5px; }
        .icon-btn:hover { background: #334155; color: white; }
        .icon-btn.danger:hover { background: #7f1d1d; border-color: #ef4444; color: white; }

        #songContainer { background: white; color: #1e293b; padding: 60px; border-radius: 8px; min-height: 800px; font-family: var(--font-mono); white-space: pre; line-height: 1.6; font-size: 17px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        #songContainer strong { color: var(--primary); font-weight: 900; }

        #mediaContainer { position: fixed; bottom: 110px; right: 20px; width: 320px; height: 180px; z-index: 999; display: none; background: black; border-radius: 12px; overflow: hidden; border: 2px solid #334155; box-shadow: 0 20px 25px rgba(0,0,0,0.6); }
        #audioVisualizer { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(to bottom, #1e1b4b, #000); color: white; }
        .drag-handle { position: absolute; top: 0; left: 0; right: 0; height: 30px; background: rgba(255,255,255,0.1); cursor: move; z-index: 1000; }

        .player-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.98); border-top: 1px solid #334155; padding: 10px 30px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; height: 80px; }
        .controls-center { display: flex; align-items: center; gap: 20px; position: absolute; left: 50%; transform: translateX(-50%); }
        .play-btn { width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: #0f172a; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .skip-btn { background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer; }
        .badge { background: #334155; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; color: #cbd5e1; }
        .badge.active { background: #10b981; color: white; }
        .db-status { position: fixed; bottom: 90px; left: 20px; font-size: 0.7rem; color: #64748b; z-index: 900; }
    </style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="playlists-section">
        <div class="playlist-header">
            <h4 style="margin:0; color:white;">MIS PLAYLISTS</h4>
            <button class="icon-btn" onclick="createNewPlaylist()" title="Nueva Playlist" style="background:transparent; border:none; font-size:1.2rem;">‚ûï</button>
        </div>
        <div class="playlist-list" id="playlistsContainer"></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding-top:10px; border-top:1px solid #1e293b;">
            <span id="currentPlaylistNameDisplay" style="font-weight:bold; color:#cbd5e1; font-size:0.9rem;">...</span>
            <div>
                <button class="icon-btn" onclick="renameCurrentPlaylist()" title="Renombrar Playlist">‚úèÔ∏è</button>
                <button class="icon-btn danger" onclick="deleteCurrentPlaylist()" title="Borrar Playlist Actual">üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <div class="songs-section">
        <div class="sidebar-title">Canciones en Lista</div>
        <div id="songsListContainer"></div>
    </div>
    
    <div style="padding:15px; border-top:1px solid #334155;">
        <button onclick="toggleSidebar()" style="width:100%; justify-content:center;">Cerrar Men√∫</button>
    </div>
</div>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="toggleSidebar()" style="background:transparent; border:1px solid #475569;">‚ò∞ <span id="headerPlaylistName">Lista</span></button>
            <h1>SongPractice <span>Studio</span></h1>
        </div>
        
        <div style="display:flex; gap: 10px;">
            <button onclick="startNewSong()" class="btn-new">‚ûï Nueva</button>
            <button onclick="toggleEditMode()" id="modeBtn">‚öôÔ∏è Configurar</button>
        </div>
    </header>

    <div class="config-panel collapsed" id="configPanel">
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>T√≠tulo Canci√≥n</label>
                <input type="text" id="songTitle" placeholder="Nombre...">
            </div>
        </div>

        <div class="source-tabs">
            <button class="tab-btn active" onclick="switchTab('youtube')" id="tabYoutube">YouTube</button>
            <button class="tab-btn" onclick="switchTab('mp3')" id="tabMp3">Archivo MP3</button>
        </div>

        <div id="sourceYoutube" class="source-content active">
            <label>Link de YouTube</label>
            <input type="text" id="ytUrl" placeholder="https://www.youtube.com/..." onchange="loadSourceMedia()">
        </div>

        <div id="sourceMp3" class="source-content">
            <label>Subir MP3 (Persistente)</label>
            <div class="file-upload">
                <label for="mp3Input" class="file-upload-label" id="mp3Label">üìÇ Seleccionar archivo</label>
                <input type="file" id="mp3Input" accept="audio/*" onchange="handleFileSelect(this)">
            </div>
        </div>

        <div class="form-grid" style="margin-top:15px;">
            <div>
                <label>Duraci√≥n</label>
                <input type="text" id="songDuration" placeholder="00:00" readonly>
            </div>
            <div style="align-self:end; color:#64748b; font-size:0.8rem; padding-bottom:10px;" id="durationStatus">...</div>
        </div>

        <label>Letra y Acordes</label>
        <textarea id="inputArea" spellcheck="false" placeholder="Pega la letra..."></textarea>
        
        <button class="save-btn" onclick="saveToCurrentPlaylist()">üíæ Guardar en <span id="saveBtnPlaylistName">...</span></button>

        <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="transpose(-1)">‚ûñ Tono</button>
            <span id="keyDisplay" style="background:#0f172a; padding:0 20px; border-radius:8px; display:flex; align-items:center; font-weight:bold; border:1px solid #334155;">Original</span>
            <button onclick="transpose(1)">‚ûï Tono</button>
            <div style="flex-grow:1;"></div>
            <button class="primary" onclick="closeEditor()">‚ùå Cancelar</button>
        </div>
    </div>

    <div id="songContainer">
        <div style="text-align:center; padding-top:100px; color:#64748b;">
            <h2>Selecciona una canci√≥n o crea una nueva</h2>
            <p>Usa el bot√≥n "Nueva" arriba a la derecha.</p>
        </div>
    </div>
</div>

<div id="mediaContainer">
    <div class="drag-handle"></div>
    <div id="youtube-player" style="display:none; height:100%;"></div>
    <div id="audioVisualizer" style="display:none;">
        <div style="font-size:3rem;">üíæ</div>
        <div style="margin-top:10px; font-weight:bold; color:#a5b4fc;">Audio Local</div>
        <audio id="html5Player" style="width:100%; margin-top:15px;" controls></audio>
    </div>
</div>

<div class="player-bar">
    <div style="width:180px;">
        <div id="statusText" style="font-weight:bold;">Listo</div>
        <div id="timeDisplay" style="font-size:0.8rem; color:#94a3b8; font-family:var(--font-mono);">00:00</div>
    </div>

    <div class="controls-center">
        <button class="skip-btn" onclick="playPrev()">‚èÆ</button>
        <button class="play-btn" id="masterPlayBtn" onclick="toggleGlobalPlay()">‚ñ∂</button>
        <button class="skip-btn" onclick="playNext()">‚è≠</button>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
        <span class="badge" id="speedBadge">Manual</span>
        <input type="range" id="scrollSpeed" min="0" max="100" value="0" step="0.5" style="width:120px;">
    </div>
</div>

<div class="db-status" id="dbStatus">DB: Init...</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    // ==========================================
    // 1. DATABASE (INDEXED DB)
    // ==========================================
    const DB_NAME = 'SongPracticeDB';
    const STORE_NAME = 'audioFiles';
    let db;

    function initDB() {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME);
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            document.getElementById('dbStatus').innerText = "DB: OK";
            initAppData(); 
        };
        request.onerror = () => document.getElementById('dbStatus').innerText = "DB Error";
    }

    function storeAudioFile(id, file, callback) {
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).put(file, id).onsuccess = () => callback(true);
        tx.onerror = () => callback(false);
    }
    function getAudioFile(id, callback) {
        const tx = db.transaction([STORE_NAME], 'readonly');
        tx.objectStore(STORE_NAME).get(id).onsuccess = (e) => callback(e.target.result);
        tx.onerror = () => callback(null);
    }
    function deleteAudioFile(id) {
        db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(id);
    }

    // ==========================================
    // 2. DATA (MULTI-PLAYLIST)
    // ==========================================
    let appData = { playlists: [], activePlaylistId: null };

    function initAppData() {
        const v9Data = localStorage.getItem('songPracticeData_v9');
        if (v9Data) {
            appData = JSON.parse(v9Data);
            const exists = appData.playlists.find(p => p.id === appData.activePlaylistId);
            if (!exists && appData.playlists.length > 0) {
                appData.activePlaylistId = appData.playlists[0].id;
                saveAppData();
            }
        } else {
            const defaultId = Date.now().toString();
            appData.playlists.push({ id: defaultId, name: "General", songs: [] });
            appData.activePlaylistId = defaultId;
            saveAppData();
        }
        renderSidebarPlaylists();
        loadCurrentPlaylistSongs();
    }

    function saveAppData() {
        localStorage.setItem('songPracticeData_v9', JSON.stringify(appData));
    }

    function getActivePlaylist() {
        return appData.playlists.find(p => p.id === appData.activePlaylistId);
    }

    // ==========================================
    // 3. PLAYLIST OPERATIONS
    // ==========================================
    
    function createNewPlaylist() {
        const name = prompt("Nombre de la nueva Playlist:", "Nueva Lista");
        if(name) {
            const newId = Date.now().toString();
            appData.playlists.push({ id: newId, name: name, songs: [] });
            switchPlaylist(newId);
        }
    }

    function renameCurrentPlaylist() {
        const active = getActivePlaylist();
        if(!active) return;
        
        const newName = prompt("Nuevo nombre para la playlist:", active.name);
        if(newName && newName.trim() !== "") {
            active.name = newName.trim();
            saveAppData();
            renderSidebarPlaylists(); 
        }
    }

    function switchPlaylist(id) {
        appData.activePlaylistId = id;
        saveAppData();
        currentIndex = -1; 
        renderSidebarPlaylists();
        loadCurrentPlaylistSongs();
        stopGlobal();
    }

    function deleteCurrentPlaylist() {
        if(appData.playlists.length <= 1) return alert("No puedes borrar la √∫ltima playlist.");
        const active = getActivePlaylist();
        if(confirm(`¬øBorrar "${active.name}"?`)) {
            active.songs.forEach(s => { if(s.type === 'mp3') deleteAudioFile(s.url); });
            appData.playlists = appData.playlists.filter(p => p.id !== active.id);
            switchPlaylist(appData.playlists[0].id);
        }
    }

    function renderSidebarPlaylists() {
        const container = document.getElementById('playlistsContainer');
        const active = getActivePlaylist();
        
        container.innerHTML = appData.playlists.map(p => `
            <div class="playlist-chip ${p.id === appData.activePlaylistId ? 'active' : ''}" 
                 onclick="switchPlaylist('${p.id}')">
                ${p.name} <span style="opacity:0.6; font-size:0.7em;">(${p.songs.length})</span>
            </div>
        `).join('');
        
        const name = active ? active.name : "Error";
        document.getElementById('currentPlaylistNameDisplay').innerText = name;
        document.getElementById('headerPlaylistName').innerText = name;
        document.getElementById('saveBtnPlaylistName').innerText = name;
    }

    // ==========================================
    // 4. SONG LOGIC & UX MEJORADO
    // ==========================================
    let currentMode = 'youtube'; 
    let currentIndex = -1;
    let ytPlayer;
    let audioPlayer = document.getElementById('html5Player');
    let tempMp3File = null;

    function loadCurrentPlaylistSongs() {
        const active = getActivePlaylist();
        const container = document.getElementById('songsListContainer');
        container.innerHTML = "";

        if(!active || active.songs.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Lista vac√≠a</div>';
            return;
        }

        container.innerHTML = active.songs.map((s, i) => `
            <div class="song-item ${i === currentIndex ? 'active' : ''}" onclick="loadSongByIndex(${i})">
                <div style="overflow:hidden;">
                    <div style="font-weight:bold; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.title}</div>
                    <div style="font-size:0.7rem; color:#94a3b8; display:flex; align-items:center; margin-top:4px;">
                        <span class="song-type ${s.type==='youtube'?'type-yt':'type-mp3'}">${s.type==='youtube'?'YT':'MP3'}</span>
                        ${s.duration || '--:--'}
                    </div>
                </div>
                <button onclick="deleteSong(event, ${i})" style="background:none; border:none; color:#ef4444; padding:0; font-size:1.2rem;">√ó</button>
            </div>
        `).join('');
    }

    function loadSongByIndex(index) {
        const active = getActivePlaylist();
        if(!active || !active.songs[index]) return;

        currentIndex = index;
        const s = active.songs[index];

        document.getElementById('songTitle').value = s.title;
        document.getElementById('inputArea').value = s.content;
        document.getElementById('songDuration').value = s.duration;
        currentStep = s.transpose || 0;
        document.getElementById('keyDisplay').innerText = currentStep === 0 ? "Original" : (currentStep > 0 ? "+" : "") + currentStep;

        updateSongView();
        switchTab(s.type);
        loadCurrentPlaylistSongs(); 

        if (s.type === 'youtube') {
            document.getElementById('ytUrl').value = s.url;
            cueVideoById();
        } else {
            document.getElementById('durationStatus').innerText = "Cargando audio...";
            getAudioFile(s.url, (blob) => {
                if(blob) {
                    audioPlayer.src = URL.createObjectURL(blob);
                    document.getElementById('mp3Label').innerText = "üìÇ Cargado de DB";
                    document.getElementById('mp3Label').classList.add('loaded');
                    document.getElementById('durationStatus').innerHTML = "<span style='color:#10b981'>‚úÖ Audio Listo</span>";
                    calculateSpeedFromDuration();
                } else {
                    alert("Audio no encontrado en DB.");
                }
            });
        }
        
        // Si el panel est√° abierto, actualizamos la vista de edici√≥n tambi√©n
        if(!document.getElementById('configPanel').classList.contains('collapsed')) {
             // Ya cargamos los valores arriba, as√≠ que todo ok.
        }
        
        restartPractice();
    }

    // --- UX MEJORADO: FUNCI√ìN START NEW SONG ---
    function startNewSong() {
        // 1. Resetear el √≠ndice (modo creaci√≥n)
        currentIndex = -1;
        
        // 2. Limpiar formulario visualmente
        clearForm();
        
        // 3. Abrir el panel
        document.getElementById('configPanel').classList.remove('collapsed');
        document.getElementById('modeBtn').innerText = "Ocultar Editor";
        
        // 4. Detener reproducci√≥n
        stopGlobal();
        window.scrollTo(0,0);
        
        // 5. Borrar vista actual de la canci√≥n (opcional, o dejar la anterior de fondo)
        document.getElementById('songContainer').innerHTML = `
            <div style="text-align:center; padding-top:50px; color:#cbd5e1;">
                <h2>Creando nueva canci√≥n...</h2>
                <p>Rellena el formulario arriba y dale a Guardar.</p>
            </div>
        `;
    }

    // --- HELPER: Limpiar Formulario ---
    function clearForm() {
        document.getElementById('songTitle').value = "";
        document.getElementById('ytUrl').value = "";
        document.getElementById('inputArea').value = "";
        document.getElementById('songDuration').value = "";
        document.getElementById('mp3Input').value = ""; // Clear file input
        document.getElementById('mp3Label').innerText = "üìÇ Seleccionar archivo";
        document.getElementById('mp3Label').classList.remove('loaded');
        document.getElementById('durationStatus').innerText = "...";
        
        // Reset transposici√≥n
        currentStep = 0;
        document.getElementById('keyDisplay').innerText = "Original";
        
        tempMp3File = null;
    }
    
    // --- HELPER: Cerrar Editor ---
    function closeEditor() {
        document.getElementById('configPanel').classList.add('collapsed');
        document.getElementById('modeBtn').innerText = "‚öôÔ∏è Configurar";
        
        // Si est√°bamos en modo "Nueva" y cancelamos, dejamos limpia la vista
        if(currentIndex === -1) {
             clearForm();
        }
    }

    async function saveToCurrentPlaylist() {
        const active = getActivePlaylist(); 
        if(!active) return alert("Error: No hay playlist seleccionada.");

        const title = document.getElementById('songTitle').value || "Sin T√≠tulo";
        const content = document.getElementById('inputArea').value;
        const duration = document.getElementById('songDuration').value;
        const type = currentMode;
        const songId = Date.now().toString(); 
        
        let url = ""; 
        
        if (type === 'youtube') {
            url = document.getElementById('ytUrl').value;
            finishSave(songId, title, content, duration, type, url);
        } else {
            if (!tempMp3File && currentIndex === -1) return alert("Falta el archivo de audio.");
            
            if (tempMp3File) {
                document.getElementById('durationStatus').innerText = "Guardando...";
                storeAudioFile(songId, tempMp3File, (success) => {
                    if(success) finishSave(songId, title, content, duration, type, songId); 
                    else alert("Error al guardar MP3.");
                });
            } else {
                const currentSong = active.songs[currentIndex];
                finishSave(currentSong.id, title, content, duration, type, currentSong.url);
            }
        }
    }

    function finishSave(id, title, content, duration, type, url) {
        const active = getActivePlaylist();
        const song = { id, title, content, duration, type, url, transpose: currentStep };
        
        if (currentIndex > -1) {
            active.songs[currentIndex] = song;
        } else {
            active.songs.push(song);
        }
        
        saveAppData(); 
        renderSidebarPlaylists(); 
        loadCurrentPlaylistSongs(); 
        
        // === UX MEJORADO: Guardar, Vaciar y Ocultar ===
        // 1. Si era nueva, seleccionamos la nueva (o no, segun preferencia. Dej√©moslo en la lista).
        // 2. Cerramos el editor
        closeEditor();
        // 3. Limpiamos el formulario para que la pr√≥xima vez est√© vac√≠o
        clearForm();
        
        // Si se edit√≥ una existente, recargar su vista
        if (currentIndex > -1) {
            loadSongByIndex(currentIndex);
        }
        
        tempMp3File = null;
        document.getElementById('durationStatus').innerText = "Listo.";
    }

    function deleteSong(e, i) {
        e.stopPropagation();
        if(confirm("¬øBorrar canci√≥n?")) {
            const active = getActivePlaylist();
            const s = active.songs[i];
            if(s.type === 'mp3') deleteAudioFile(s.url);
            active.songs.splice(i, 1);
            if(i === currentIndex) currentIndex = -1;
            saveAppData();
            renderSidebarPlaylists();
            loadCurrentPlaylistSongs();
            document.getElementById('songContainer').innerHTML = ""; // Limpiar vista
        }
    }

    function playNext() {
        const active = getActivePlaylist();
        if(!active || !active.songs.length) return;
        let n = currentIndex + 1;
        if(n >= active.songs.length) n = 0;
        loadSongByIndex(n);
    }
    
    function playPrev() {
        const active = getActivePlaylist();
        if(!active || !active.songs.length) return;
        let n = currentIndex - 1;
        if(n < 0) n = active.songs.length - 1;
        loadSongByIndex(n);
    }

    // ==========================================
    // 5. UTILS & UI
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        initDB(); 
        audioPlayer.onloadedmetadata = () => {
            if(currentMode === 'mp3') {
                const dur = audioPlayer.duration;
                document.getElementById('songDuration').value = formatTime(dur);
                calculateSpeedFromDuration();
            }
        };
        audioPlayer.onplay = () => updatePlayerState('playing');
        audioPlayer.onpause = () => updatePlayerState('paused');
        audioPlayer.onended = () => { updatePlayerState('ended'); setTimeout(playNext, 1500); };
    });

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.source-content').forEach(c => c.classList.remove('active'));
        if (mode === 'youtube') {
            document.getElementById('tabYoutube').classList.add('active');
            document.getElementById('sourceYoutube').classList.add('active');
        } else {
            document.getElementById('tabMp3').classList.add('active');
            document.getElementById('sourceMp3').classList.add('active');
        }
        stopGlobal();
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            tempMp3File = file;
            document.getElementById('mp3Label').innerText = "üìÇ " + file.name;
            audioPlayer.src = URL.createObjectURL(file);
            if(document.getElementById('songTitle').value === "") {
                document.getElementById('songTitle').value = file.name.replace(/\.[^/.]+$/, "");
            }
        }
    }

    function toggleEditMode() {
        const p = document.getElementById('configPanel');
        
        // Si est√° colapsado, lo abrimos
        if(p.classList.contains('collapsed')) {
            p.classList.remove('collapsed'); 
            document.getElementById('modeBtn').innerText="Ocultar Editor"; 
            stopGlobal();
            
            // Si hay una canci√≥n seleccionada, nos aseguramos que los datos est√©n cargados
            if(currentIndex !== -1) {
                // Ya deber√≠an estar cargados por loadSongByIndex, pero por seguridad
                const active = getActivePlaylist();
                if(active && active.songs[currentIndex]) {
                    // Los inputs ya tienen los valores
                }
            }
            
        } else {
            // Si est√° abierto, lo cerramos
            closeEditor();
        }
    }
    
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

    // PLAYBACK
    function toggleGlobalPlay() {
        if(currentMode === 'youtube') {
            if(!ytPlayer || !ytPlayer.getPlayerState) return;
            const s = ytPlayer.getPlayerState();
            s === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
        } else {
            audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
        }
    }
    function stopGlobal() {
        if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
        audioPlayer.pause();
        stopScrollEngine();
    }
    function updatePlayerState(s) {
        const btn = document.getElementById('masterPlayBtn');
        const txt = document.getElementById('statusText');
        const media = document.getElementById('mediaContainer');
        
        if(s === 'playing') {
            btn.innerText = "‚ùö‚ùö"; txt.innerText = "Ensayando..."; startScrollEngine();
            media.style.display = 'block';
            document.getElementById('youtube-player').style.display = currentMode==='youtube'?'block':'none';
            document.getElementById('audioVisualizer').style.display = currentMode==='mp3'?'flex':'none';
        } else {
            btn.innerText = "‚ñ∂"; txt.innerText = s==='ended'?"Fin":"Pausado"; stopScrollEngine();
        }
    }
    function restartPractice() {
        window.scrollTo(0,0);
        if(currentMode==='youtube' && ytPlayer.seekTo) { ytPlayer.seekTo(0); ytPlayer.pauseVideo(); }
        if(currentMode==='mp3') { audioPlayer.currentTime=0; audioPlayer.pause(); }
        stopScrollEngine(); scrollAccumulator=0;
        document.getElementById('masterPlayBtn').innerText="‚ñ∂";
    }

    // YT API
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('youtube-player', {
            height: '100%', width: '100%', playerVars: { 'playsinline': 1, 'autoplay': 0 },
            events: {
                'onStateChange': (e) => {
                    if(currentMode !== 'youtube') return;
                    if(e.data===YT.PlayerState.PLAYING) updatePlayerState('playing');
                    else if(e.data===YT.PlayerState.PAUSED) updatePlayerState('paused');
                    else if(e.data===YT.PlayerState.ENDED) { updatePlayerState('ended'); setTimeout(playNext, 2000); }
                    if(e.data===YT.PlayerState.CUED||e.data===YT.PlayerState.PLAYING){
                         const d=ytPlayer.getDuration(); if(d>0){document.getElementById('songDuration').value=formatTime(d);calculateSpeedFromDuration();}
                    }
                }
            }
        });
    }
    function cueVideoById() {
        const url=document.getElementById('ytUrl').value;
        const m=url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        if(m && m[2].length==11) { document.getElementById('mediaContainer').style.display='block'; ytPlayer.cueVideoById(m[2]); }
    }
    function loadSourceMedia() { if(currentMode==='youtube') cueVideoById(); }

    // MUSICAL & SCROLL
    const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const flats=['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
    let currentStep=0;
    const chordRegex=/\b([A-G][b#]?(?:maj|min|m|M|aug|dim|sus|add|alt|b5|#5|[0-9]|\+|\-|\(|\))*)(?:\/([A-G][b#]?))?\b/g;
    document.getElementById('inputArea').addEventListener('input', updateSongView);
    
    function transpose(d){currentStep+=d; document.getElementById('keyDisplay').innerText=currentStep===0?"Original":(currentStep>0?"+":"")+currentStep; updateSongView();}
    function updateSongView(){
        const txt=document.getElementById('inputArea').value; const lines=txt.split('\n'); let used=[];
        const p=lines.map(l=>{ if(isChordLine(l)){ return l.replace(chordRegex,(m,r,b)=>{const tr=tn(r,currentStep); const tb=b?"/"+tn(b,currentStep):""; const f=tr+tb; if(!used.includes(f))used.push(f); return `<strong>${f}</strong>`;}); } return l.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); });
        let leg=used.length?`<div style="margin-bottom:30px; padding:20px; background:#f8fafc; border-left:5px solid var(--primary); color:#334155; border-radius:4px;">üé∏ <b>ACORDES:</b> ${used.join(' ')}</div>`:"";
        document.getElementById('songContainer').innerHTML=leg+p.join('\n')+"<br><br><br><br>";
    }
    function isChordLine(l){if(!l.trim())return false; const w=l.trim().split(/\s+/); let c=0; w.forEach(x=>{if(x.replace(/[()]/g,'').match(/^[A-G][b#]?(maj|min|m|M|aug|dim|sus|add|alt|b5|#5|[0-9]|\+|\-|\(|\/)*$/))c++;}); return (c/w.length>0.4)&&!w.some(k=>k.length>8);}
    function tn(p,s){return p.replace(/[A-G][b#]?/,(n)=>{let i=notes.indexOf(n); let uf=(i===-1&&flats.indexOf(n)!==-1); if(i===-1)i=flats.indexOf(n); if(i===-1)return n; let ni=(i+s)%12; while(ni<0)ni+=12; return uf?flats[ni]:notes[ni];});}

    function formatTime(s){const m=Math.floor(s/60); const sc=Math.floor(s%60); return `${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;}
    let useCalculatedSpeed=false, calculatedPixelsPerFrame=0, isScrolling=false, scrollAccumulator=0, scrollRequest;
    function calculateSpeedFromDuration(){
        const v=document.getElementById('songDuration').value; if(!v.includes(':'))return; const p=v.split(':'); const sec=(parseInt(p[0])*60)+parseInt(p[1]); if(sec<=0)return;
        const dist=document.body.scrollHeight-window.innerHeight; if(dist<=0)return;
        calculatedPixelsPerFrame=(dist/sec)/60; useCalculatedSpeed=true; document.getElementById('speedBadge').innerText="AUTO"; document.getElementById('speedBadge').classList.add('active'); document.getElementById('scrollSpeed').value=calculatedPixelsPerFrame*20;
    }
    function startScrollEngine(){
        isScrolling=true; function loop(){
            if(!isScrolling)return; const atBottom=(window.innerHeight+window.scrollY)>=document.body.offsetHeight-2;
            if(!atBottom){
                let ppf=useCalculatedSpeed?calculatedPixelsPerFrame:(parseFloat(document.getElementById('scrollSpeed').value)/20);
                if(ppf>0){ scrollAccumulator+=ppf; if(scrollAccumulator>=1){const m=Math.floor(scrollAccumulator); window.scrollBy(0,m); scrollAccumulator-=m;}}
            }
            scrollRequest=requestAnimationFrame(loop);
        } scrollRequest=requestAnimationFrame(loop);
    }
    function stopScrollEngine(){isScrolling=false; cancelAnimationFrame(scrollRequest);}
    document.getElementById('scrollSpeed').addEventListener('input',()=>{useCalculatedSpeed=false; document.getElementById('speedBadge').innerText="MANUAL"; document.getElementById('speedBadge').classList.remove('active');});
    
    setInterval(()=>{
        let c=0; let t=document.getElementById('songDuration').value||"00:00";
        if(currentMode==='youtube'&&ytPlayer&&ytPlayer.getCurrentTime) c=ytPlayer.getCurrentTime();
        else if(currentMode==='mp3') c=audioPlayer.currentTime;
        document.getElementById('timeDisplay').innerText=`${formatTime(c)} / ${t}`;
    },1000);
</script>
</body>
</html>